<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Админ-панель | CyberSquare</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/theme.css">

  <!-- DataTables (сортировка/поиск по таблицам) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
</head>

<body class="bg-light d-flex flex-column min-vh-100">

<header class="cs-header">
  <div class="container py-3 d-flex align-items-center justify-content-between">
    <div class="cs-logo">CyberSquare</div>
    <div id="burger-menu" class="burger-menu ms-3" aria-label="menu">
      <span></span><span></span><span></span>
    </div>
  </div>
  <nav id="nav-links" class="nav-links">
    <div class="container pb-3">
      <ul id="nav-ul" class="nav nav-pills flex-column flex-md-row gap-2"></ul>
    </div>
  </nav>
</header>

<main class="container py-5 flex-grow-1">

  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1">Админ-панель</h1>
      <div class="text-muted">Управление пользователями, курсами, записями и отзывами</div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="goHome()">На главную</button>
      <button class="btn btn-outline-danger" onclick="logout()">Выйти</button>
    </div>
  </div>

  <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-enrollments" type="button" role="tab">
        Записи на курсы
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-reviews" type="button" role="tab">
        Отзывы
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-courses" type="button" role="tab">
        Курсы
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-users" type="button" role="tab">
        Пользователи
      </button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- ===== ENROLLMENTS ===== -->
    <div class="tab-pane fade show active" id="tab-enrollments" role="tabpanel">
      <div class="card cs-card p-3 p-md-4">
        <h2 class="h5 mb-3">Записи на курсы</h2>

        <div class="table-responsive">
          <table id="enrollmentsTable" class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Студент</th>
                <th>Курс</th>
                <th>Статус</th>
                <th>Дата записи</th>
                <th style="width:260px;">Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="text-muted small mt-2">
          Статусы можно менять (active/completed/canceled).
        </div>
      </div>
    </div>

    <!-- ===== REVIEWS ===== -->
    <div class="tab-pane fade" id="tab-reviews" role="tabpanel">
      <div class="card cs-card p-3 p-md-4">
        <h2 class="h5 mb-3">Отзывы</h2>

        <div class="table-responsive">
          <table id="reviewsTable" class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Автор</th>
                <th>Курс</th>
                <th>Оценка</th>
                <th>Комментарий</th>
                <th>Дата</th>
                <th style="width:120px;">Удалить</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="text-muted small mt-2">
          Удаление доступно только администратору.
        </div>
      </div>
    </div>

    <!-- ===== COURSES ===== -->
    <div class="tab-pane fade" id="tab-courses" role="tabpanel">
      <div class="card cs-card p-3 p-md-4">
        <h2 class="h5 mb-3">Курсы</h2>

        <div class="table-responsive">
          <table id="coursesTable" class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Категория</th>
                <th>Цена</th>
                <th>Опубликован</th>
                <th>Создан</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== USERS ===== -->
    <div class="tab-pane fade" id="tab-users" role="tabpanel">
      <div class="card cs-card p-3 p-md-4">
        <h2 class="h5 mb-3">Пользователи</h2>

        <div class="table-responsive">
          <table id="usersTable" class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>ФИО</th>
                <th>Email</th>
                <th>Роль</th>
                <th>Создан</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>
</main>

<script src="/js/nav.js" defer></script>
<div id="footer-holder"></div>
<script src="/js/footer.js" defer></script>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  // ===== Guard: только admin =====
  const role = localStorage.getItem('role');
  if (role !== 'admin') location.href = 'login.html';

  function goHome(){ location.href = 'index.html'; }
  function logout(){
    localStorage.clear();
    location.href = 'login.html';
  }

  function apiHeaders(extra = {}) {
    return { 'x-role': role, ...extra };
  }

  // ===== DataTable instances =====
  let dtEnrollments = null;
  let dtReviews     = null;
  let dtCourses     = null;
  let dtUsers       = null;

  async function loadEnrollments() {
    const res = await fetch('/api/admin/enrollments', { headers: apiHeaders() });
    const data = await res.json();

    const tbody = document.querySelector('#enrollmentsTable tbody');
    tbody.innerHTML = '';

    data.forEach(e => {
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${e.enrollment_id}</td>
          <td>${e.full_name}</td>
          <td>${e.course_title}</td>
          <td><span class="badge text-bg-light">${e.status}</span></td>
          <td>${new Date(e.enrolled_at).toLocaleString()}</td>
          <td>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-success" onclick="setEnrollmentStatus(${e.enrollment_id}, 'active')">active</button>
              <button class="btn btn-sm btn-outline-primary" onclick="setEnrollmentStatus(${e.enrollment_id}, 'completed')">completed</button>
              <button class="btn btn-sm btn-outline-danger"  onclick="setEnrollmentStatus(${e.enrollment_id}, 'canceled')">canceled</button>
            </div>
          </td>
        </tr>
      `);
    });

    if (dtEnrollments) dtEnrollments.destroy();
    dtEnrollments = $('#enrollmentsTable').DataTable({
      order: [[0, 'desc']],
      pageLength: 10
    });
  }

  async function setEnrollmentStatus(enrollmentId, status) {
    const res = await fetch('/api/admin/enrollments/' + enrollmentId + '/status', {
      method: 'PATCH',
      headers: apiHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ status })
    });
    const json = await res.json();
    if (!res.ok) return alert(json.error || 'Ошибка');
    loadEnrollments();
  }

  async function loadReviews() {
    const res = await fetch('/api/admin/reviews', { headers: apiHeaders() });
    const data = await res.json();

    const tbody = document.querySelector('#reviewsTable tbody');
    tbody.innerHTML = '';

    data.forEach(r => {
      const stars = '★'.repeat(r.rating) + '☆'.repeat(5 - r.rating);
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${r.review_id}</td>
          <td>${r.full_name}</td>
          <td>${r.course_title}</td>
          <td class="text-warning" style="letter-spacing:.5px;">${stars}</td>
          <td>${(r.comment || '').slice(0, 120)}${(r.comment && r.comment.length > 120) ? '…' : ''}</td>
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteReview(${r.review_id})">Удалить</button>
          </td>
        </tr>
      `);
    });

    if (dtReviews) dtReviews.destroy();
    dtReviews = $('#reviewsTable').DataTable({
      order: [[0, 'desc']],
      pageLength: 10
    });
  }

  async function deleteReview(id) {
    if (!confirm('Удалить отзыв?')) return;

    // можно удалять через /api/reviews/:id, но тут сделаем через /api/admin/reviews/:id
    const res = await fetch('/api/admin/reviews/' + id, {
      method: 'DELETE',
      headers: apiHeaders()
    });
    const json = await res.json();
    if (!res.ok) return alert(json.error || 'Ошибка');
    loadReviews();
  }

  async function loadCourses() {
    const res = await fetch('/api/admin/courses', { headers: apiHeaders() });
    const data = await res.json();

    const tbody = document.querySelector('#coursesTable tbody');
    tbody.innerHTML = '';

    data.forEach(c => {
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${c.course_id}</td>
          <td>${c.title}</td>
          <td>${c.category_name}</td>
          <td>${Number(c.price).toLocaleString('ru-RU')} ₽</td>
          <td>${c.is_published ? 'Да' : 'Нет'}</td>
          <td>${new Date(c.created_at).toLocaleDateString()}</td>
        </tr>
      `);
    });

    if (dtCourses) dtCourses.destroy();
    dtCourses = $('#coursesTable').DataTable({
      order: [[0, 'asc']],
      pageLength: 10
    });
  }

  async function loadUsers() {
    const res = await fetch('/api/admin/users', { headers: apiHeaders() });
    const data = await res.json();

    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';

    data.forEach(u => {
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${u.user_id}</td>
          <td>${u.full_name}</td>
          <td>${u.email}</td>
          <td><span class="badge text-bg-light">${u.role}</span></td>
          <td>${new Date(u.created_at).toLocaleString()}</td>
        </tr>
      `);
    });

    if (dtUsers) dtUsers.destroy();
    dtUsers = $('#usersTable').DataTable({
      order: [[0, 'desc']],
      pageLength: 10
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadEnrollments();
    loadReviews();
    loadCourses();
    loadUsers();
  });
</script>

</body>
</html>
