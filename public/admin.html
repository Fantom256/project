<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Админ-панель | CyberSquare</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/theme.css">

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
</head>

<body class="bg-light d-flex flex-column min-vh-100">

<header class="cs-header">
  <div class="container py-3 d-flex align-items-center justify-content-between">
    <div class="cs-logo">CyberSquare</div>
    <div id="burger-menu" class="burger-menu ms-3" aria-label="menu">
      <span></span><span></span><span></span>
    </div>
  </div>
  <nav id="nav-links" class="nav-links">
    <div class="container pb-3">
      <ul id="nav-ul" class="nav nav-pills flex-column flex-md-row gap-2"></ul>
    </div>
  </nav>
</header>

<main class="container py-5 flex-grow-1">

  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1">Админ-панель</h1>
      <div class="text-muted">Управление пользователями, курсами, записями и отзывами</div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="goHome()">На главную</button>
      <button class="btn btn-outline-danger" onclick="logout()">Выйти</button>
    </div>
  </div>

  <!-- сюда будем выводить ошибки API вместо "тихого" падения -->
  <div id="adminAlert" class="alert alert-warning d-none"></div>

  <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-enrollments" type="button" role="tab">
        Записи на курсы
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-reviews" type="button" role="tab">
        Отзывы
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-courses" type="button" role="tab">
        Курсы
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-users" type="button" role="tab">
        Пользователи
      </button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- ===== ENROLLMENTS ===== -->
    <div class="tab-pane fade show active" id="tab-enrollments" role="tabpanel">
      <div class="card cs-card p-3 p-md-4">
        <h2 class="h5 mb-3">Записи на курсы</h2>

        <div class="table-responsive">
          <table id="enrollmentsTable" class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Студент</th>
                <th>Курс</th>
                <th>Статус</th>
                <th>Дата записи</th>
                <th style="width:260px;">Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        
      </div>
    </div>

    <!-- ===== REVIEWS ===== -->
    <div class="tab-pane fade" id="tab-reviews" role="tabpanel">
      <div class="card cs-card p-3 p-md-4">
        <h2 class="h5 mb-3">Отзывы</h2>

        <div class="table-responsive">
          <table id="reviewsTable" class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Автор</th>
                <th>Курс</th>
                <th>Оценка</th>
                <th>Комментарий</th>
                <th>Дата</th>
                <th style="width:120px;">Удалить</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="text-muted small mt-2">
          Удаление доступно только администратору.
        </div>
      </div>
    </div>

    <!-- ===== COURSES ===== -->
    <div class="tab-pane fade" id="tab-courses" role="tabpanel">
      <div class="card cs-card p-3 p-md-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 m-0">Курсы</h2>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-outline-primary" onclick="openCourseModal()">Добавить курс</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadCourses()">Обновить</button>
            <a class="btn btn-sm btn-outline-primary" href="courses.html">Открыть витрину</a>
          </div>
        </div>

        <div class="table-responsive">
          <table id="coursesTable" class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Категория</th>
                <th>Цена</th>
                <th>Опубликован</th>
                <th>Создан</th>
                <th style="width:180px;">Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- ===== USERS ===== -->
    <div class="tab-pane fade" id="tab-users" role="tabpanel">
      <div class="card cs-card p-3 p-md-4">
        <h2 class="h5 mb-3">Пользователи</h2>

        <div class="table-responsive">
          <table id="usersTable" class="table table-striped align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>ФИО</th>
                <th>Email</th>
                <th>Роль</th>
                <th>Создан</th>
                <th style="width:120px;">Удалить</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="text-muted small mt-2">
          Пользователя с ролью <b>admin</b> удалить нельзя.
        </div>
      </div>
    </div>

  </div>
</main>

<!-- ===== Modal (важно: ДО скрипта, чтобы courseForm существовал) ===== -->
<div class="modal fade" id="courseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="courseForm">
        <div class="modal-header">
          <h5 class="modal-title" id="courseModalTitle">Курс</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="course_id">

          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Название</label>
              <input class="form-control" id="title" required>
            </div>

            <div class="col-12">
              <label class="form-label">Описание</label>
              <textarea class="form-control" id="description" rows="3" required></textarea>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Цена</label>
              <input class="form-control" id="price" type="number" step="0.01" required>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Длительность (мес.)</label>
              <input class="form-control" id="duration_months" type="number" min="1" value="3">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Категория</label>
              <select class="form-select" id="category_id" required></select>
            </div>

            <div class="col-12">
              <label class="form-label">Ссылка на картинку (image_url)</label>
              <input class="form-control" id="image_url" placeholder="/img/courses/xxx.jpg или https://...">
            </div>

            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="is_published" checked>
                <label class="form-check-label" for="is_published">Опубликован</label>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Отмена</button>
          <button class="btn btn-primary" type="submit">Сохранить</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="/js/nav.js" defer></script>
<div id="footer-holder"></div>
<script src="/js/footer.js" defer></script>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  // ===== Guard =====
  const role = localStorage.getItem('role');
  if (role !== 'admin') location.href = 'login.html';

  function goHome(){ location.href = 'index.html'; }
  function logout(){
    localStorage.clear();
    location.href = 'login.html';
  }

  function showAlert(msg) {
    const el = document.getElementById('adminAlert');
    el.textContent = msg;
    el.classList.remove('d-none');
  }
  function hideAlert() {
    document.getElementById('adminAlert').classList.add('d-none');
  }

  function apiHeaders(extra = {}) {
    const token = localStorage.getItem('token');
    return {
      ...(token ? { 'Authorization': 'Bearer ' + token } : {}),
      'x-role': role, // fallback
      ...extra
    };
  }

  async function apiGetArray(url) {
    const res = await fetch(url, { headers: apiHeaders() });
    const json = await res.json().catch(() => ({}));

    if (res.status === 401) {
      showAlert(json.error || 'Сессия истекла. Войдите заново.');
      localStorage.clear();
      location.href = 'login.html';
      return [];
    }

    if (!res.ok) {
      showAlert((json && json.error) ? json.error : ('Ошибка API: ' + url));
      console.error('API error', url, res.status, json);
      return [];
    }

    if (!Array.isArray(json)) {
      showAlert('Неожиданный ответ API: ' + url);
      console.error('Not array', url, json);
      return [];
    }

    hideAlert();
    return json;
  }

  function initDataTable(tableId, currentInstance, options) {
    // если DataTables не загрузился — не ломаем страницу
    if (!window.jQuery || !jQuery.fn || !jQuery.fn.DataTable) return currentInstance;
    if (currentInstance) currentInstance.destroy();
    return jQuery(tableId).DataTable(options);
  }

  let dtEnrollments = null;
  let dtReviews     = null;
  let dtCourses     = null;
  let dtUsers       = null;

  let courseModal;

  async function loadCategoriesToSelect(selectedId = null) {
    const res = await fetch('/api/admin/categories', { headers: apiHeaders() });
    const json = await res.json().catch(() => []);
    if (!res.ok) {
      showAlert(json.error || 'Ошибка категорий');
      return;
    }
    const sel = document.getElementById('category_id');
    sel.innerHTML = (json || []).map(c => `<option value="${c.category_id}">${c.name}</option>`).join('');
    if (selectedId) sel.value = String(selectedId);
  }

  async function openCourseModal(course = null) {
    if (!courseModal) courseModal = new bootstrap.Modal('#courseModal');

    document.getElementById('course_id').value = course?.course_id ?? '';
    document.getElementById('title').value = course?.title ?? '';
    document.getElementById('description').value = course?.description ?? '';
    document.getElementById('price').value = course?.price ?? '';
    document.getElementById('duration_months').value = course?.duration_months ?? 3;
    document.getElementById('image_url').value = course?.image_url ?? '';
    document.getElementById('is_published').checked = !!(course?.is_published ?? true);

    document.getElementById('courseModalTitle').textContent =
      course ? `Редактирование курса #${course.course_id}` : 'Добавить курс';

    await loadCategoriesToSelect(course?.category_id ?? null);
    courseModal.show();
  }

  function editCourse(encodedJson) {
    const course = JSON.parse(decodeURIComponent(encodedJson));
    openCourseModal(course);
  }

  document.getElementById('courseForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = document.getElementById('course_id').value;

    const body = {
      title: document.getElementById('title').value.trim(),
      description: document.getElementById('description').value.trim(),
      price: Number(document.getElementById('price').value),
      duration_months: Number(document.getElementById('duration_months').value || 3),
      image_url: document.getElementById('image_url').value.trim() || null,
      category_id: Number(document.getElementById('category_id').value),
      is_published: document.getElementById('is_published').checked
    };

    const url = id ? `/api/admin/courses/${id}` : '/api/admin/courses';
    const method = id ? 'PATCH' : 'POST';

    const res = await fetch(url, {
      method,
      headers: apiHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(body)
    });

    const json = await res.json().catch(() => ({}));
    if (!res.ok) {
      showAlert(json.error || 'Ошибка сохранения курса');
      return;
    }

    courseModal?.hide();
    loadCourses();
  });

  async function deleteCourse(id) {
    if (!confirm('Удалить курс?')) return;
    const res = await fetch('/api/admin/courses/' + id, { method: 'DELETE', headers: apiHeaders() });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) { showAlert(json.error || 'Ошибка удаления курса'); return; }
    loadCourses();
  }

  async function deleteReview(id) {
    if (!confirm('Удалить отзыв?')) return;
    const res = await fetch('/api/admin/reviews/' + id, { method: 'DELETE', headers: apiHeaders() });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) { showAlert(json.error || 'Ошибка удаления отзыва'); return; }
    loadReviews();
  }

  async function deleteUser(id) {
    if (!confirm('Удалить пользователя?')) return;
    const res = await fetch('/api/admin/users/' + id, { method: 'DELETE', headers: apiHeaders() });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) { showAlert(json.error || 'Ошибка удаления пользователя'); return; }
    loadUsers();
  }

  async function loadEnrollments() {
    const data = await apiGetArray('/api/admin/enrollments');
    const tbody = document.querySelector('#enrollmentsTable tbody');
    tbody.innerHTML = '';

    data.forEach(e => {
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${e.enrollment_id}</td>
          <td>${e.full_name}</td>
          <td>${e.course_title}</td>
          <td><span class="badge text-bg-light">${e.status}</span></td>
          <td>${new Date(e.enrolled_at).toLocaleString()}</td>
          <td>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-success" onclick="setEnrollmentStatus(${e.enrollment_id}, 'active')">active</button>
              <button class="btn btn-sm btn-outline-primary" onclick="setEnrollmentStatus(${e.enrollment_id}, 'completed')">completed</button>
              <button class="btn btn-sm btn-outline-danger"  onclick="setEnrollmentStatus(${e.enrollment_id}, 'canceled')">canceled</button>
            </div>
          </td>
        </tr>
      `);
    });

    dtEnrollments = initDataTable('#enrollmentsTable', dtEnrollments, { order: [[0,'desc']], pageLength: 10 });
  }

  async function setEnrollmentStatus(enrollmentId, status) {
    const res = await fetch('/api/admin/enrollments/' + enrollmentId + '/status', {
      method: 'PATCH',
      headers: apiHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ status })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) { showAlert(json.error || 'Ошибка смены статуса'); return; }
    loadEnrollments();
  }

  async function loadReviews() {
    const data = await apiGetArray('/api/admin/reviews');
    const tbody = document.querySelector('#reviewsTable tbody');
    tbody.innerHTML = '';

    data.forEach(r => {
      const stars = '★'.repeat(r.rating) + '☆'.repeat(5 - r.rating);
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${r.review_id}</td>
          <td>${r.full_name}</td>
          <td>${r.course_title}</td>
          <td class="text-warning" style="letter-spacing:.5px;">${stars}</td>
          <td>${(r.comment || '').slice(0, 120)}${(r.comment && r.comment.length > 120) ? '…' : ''}</td>
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td><button class="btn btn-sm btn-outline-danger" onclick="deleteReview(${r.review_id})">Удалить</button></td>
        </tr>
      `);
    });

    dtReviews = initDataTable('#reviewsTable', dtReviews, { order: [[0,'desc']], pageLength: 10 });
  }

  async function loadCourses() {
    const data = await apiGetArray('/api/admin/courses');
    const tbody = document.querySelector('#coursesTable tbody');
    tbody.innerHTML = '';

    data.forEach(c => {
      const safeJson = encodeURIComponent(JSON.stringify(c));
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${c.course_id}</td>
          <td>${c.title}</td>
          <td>${c.category_name}</td>
          <td>${Number(c.price).toLocaleString('ru-RU')} ₽</td>
          <td>${c.is_published ? 'Да' : 'Нет'}</td>
          <td>${new Date(c.created_at).toLocaleDateString()}</td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" onclick="editCourse('${safeJson}')">Редакт.</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCourse(${c.course_id})">Удалить</button>
            </div>
          </td>
        </tr>
      `);
    });

    dtCourses = initDataTable('#coursesTable', dtCourses, { order: [[0,'asc']], pageLength: 10 });
  }

  async function loadUsers() {
    const data = await apiGetArray('/api/admin/users');
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';

    data.forEach(u => {
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${u.user_id}</td>
          <td>${u.full_name}</td>
          <td>${u.email}</td>
          <td><span class="badge text-bg-light">${u.role}</span></td>
          <td>${new Date(u.created_at).toLocaleString()}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger"
                    ${u.role === 'admin' ? 'disabled title="Нельзя удалить администратора"' : ''}
                    onclick="deleteUser(${u.user_id})">
              Удалить
            </button>
          </td>
        </tr>
      `);
    });

    dtUsers = initDataTable('#usersTable', dtUsers, { order: [[0,'desc']], pageLength: 10 });
  }

  // Инициализация
  window.addEventListener('load', () => {
    loadEnrollments();
    loadReviews();
    loadCourses();
    loadUsers();
  });
</script>

</body>
</html>

